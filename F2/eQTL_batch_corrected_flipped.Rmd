---
title: "eQTL_batch_corrected_flipped"
output: html_document
---

* Purpose of this script is to repeat the eQTL analysis with several LG flipped 

### import lib
```{r} 
library(tidyverse) 
library(qtl)
library(snowfall) 
library(ggrepel) 
library(Biostrings) 
source("~/KIAT/function_BnRNAseq.R")    
```

### scanone 

### with flipped LG for eQTL anlaysis just for the plot 

```{r}
cross.F2 <- read.cross("csvsr", genfile ="~/F2/data/QTL_analysis/LG.f2.madmapper.final_gen_revised_flipped.csv", 
                         phefile = "~/F2/output/network_analysis/vstMat.f2.batch.corrected_revised.csv",
                         genotypes = c("AA", "AB", "BB"))   # although the sample IDs are not matched in the original phe and gen file, I still get the right result. 

cross.F2 <- sim.geno(cross.F2,step=1,n.draws=32) # imputation?  
cross.F2 <- calc.genoprob(cross.F2,step=1) 

scanone_eQTL.F2 <- scanone(cross.F2, pheno.col = 2:ncol(cross.F2$pheno), 
	         method = "imp", use = "all.obs")  

### permutation...  
set.seed(12345)   
permtest.F2 <- scanone(cross.F2, pheno.col = 2, method = "imp", n.perm = 10000)  

alphas <- seq(0.01, 0.10, by = 0.01) 
lod.thrs <- summary(permtest.F2, alphas) 
lod.thrs   

save(cross.F2, scanone_eQTL.F2, permtest.F2, lod.thrs, file = "~/F2/output/eQTL/scanone-eqtl_F2_flipped.RData")  
``` 

### determine cis- and trans- eQTL 
```{r}
load("~/F2/output/eQTL/scanone-eqtl_F2_flipped.RData")
scanone_eQTL.F2 %>% dim() # 4887 56182 

scanone_eQTL.F2$chr <- as.character(scanone_eQTL.F2$chr) 

# get threshold 
threshold.95 <- lod.thrs[5,] 
threshold.95 # 4.13 

# get all eQTL based on this threshold   
eQTL_sign <- 
sapply(colnames(scanone_eQTL.F2), function(gene) {
  sum(scanone_eQTL.F2[,gene] > threshold.95) > 0 
}) 

sum(eQTL_sign) # 22,868 genes with eQTL 
scanone_eQTL.F2 <- scanone_eQTL.F2[,eQTL_sign]  
dim(scanone_eQTL.F2) # 4887 22868 

# get bayesint result for every gene 
scanone.gather <-  
scanone_eQTL.F2 %>% 
  gather(key = trait, value = LOD, -chr, -pos) 

sig.chrs <- scanone.gather %>% filter(LOD > threshold.95) %>% 
  group_by(trait,chr) %>% 
  dplyr::summarise(count = n()) # this is to get the significant chr ID for each trait 

sig.chrs 
sig.chrs %>% dim() # 26581        3

bayesint.list <- apply(sig.chrs,1,function(hit) { # for every row("trait, chr, count") in eigengene module 
    result <- bayesint(scanone_eQTL.F2[c("chr","pos",hit["trait"])],  
                     chr=hit["chr"], 
                     lodcolumn = 1, 
                     expandtomarkers = TRUE 
  )
  colnames(result)[3] <- "LOD" 
  result
})  

names(bayesint.list) <- sig.chrs$trait

bayesint.list <- lapply(bayesint.list,function(x) 
                          x %>% 
                          as.data.frame() %>%
                          rownames_to_column(var="markername")  %>% # make rownames to column and use "markername" as the colname for the new colomn  
                          mutate(chr=as.character(chr)) 
)  

bayesint.result <- 
as.tibble(bind_rows(bayesint.list,.id="trait")) %>% # combine list into tibble 
    dplyr::select(trait,chr,pos,markername,LOD) %>%  
    separate(markername,into=c("chr1","Mbp"),sep="_", convert=TRUE) %>%  
    group_by(trait,chr) %>% 
    dplyr::summarize(start=min(Mbp, na.rm = T),end=max(Mbp, na.rm = T), pos=median(pos, na.rm = T), min_eQTL_LOD=min(LOD),max_eQTL_LOD=max(LOD)) %>% 
  #for the high QTL peaks the interval width is 0.  That is overly precise and need to widen those.
  # mutate(start=ifelse(start==end, start-20000,start), end=ifelse(start==end,end+20000,end)) 
  mutate(start=ifelse(start-1000000>0, start-1000000, 0), end=end+1000000) 
  

bayesint.result %>% dim() # 26581     7  

# get genome range 
library(IRanges)
library(GenomicRanges)
library(GenomicFeatures) 
library("rtracklayer") 

### get gff file with gene chrom & pos info, gff3 file must be sorted 
gff.mRNA <- read.table("~/Reference/B.napus/gff.mRNA")
dim(gff.mRNA) # 101040      4 
head(gff.mRNA) 
colnames(gff.mRNA) <- c("CHROM", "start", "end", "gene_ID") 
gff.mRNA %>% head()  

# look for cis-eQTL 
bayesint.result.2 <- 
bayesint.result %>% 
  mutate(gene_ID = trait, eQTL_chr = chr, eQTL_start = start, eQTL_end = end) %>% 
  dplyr::select(trait, gene_ID, eQTL_chr, pos, eQTL_start, eQTL_end, min_eQTL_LOD, max_eQTL_LOD) %>% 
  left_join(gff.mRNA, by = "gene_ID") 

bayesint.result.2$eQTL_chr <- paste("chr", bayesint.result.2$eQTL_chr, sep = "")
bayesint.result.2 %>% head()

cis_eQTL <- 
bayesint.result.2 %>% 
  filter(eQTL_chr == CHROM) %>% 
  filter((start < eQTL_start & end > eQTL_start) | # also need SNP pos... 
         (start >= eQTL_start & end <= eQTL_end) |
         (start < eQTL_end & end > eQTL_end)) 

dim(cis_eQTL) # 11710   12 

trans_eQTL <- 
bayesint.result.2 %>% 
  anti_join(cis_eQTL) 

save(cis_eQTL, trans_eQTL, file = "~/F2/output/eQTL/cis_trans_result_new_flipped.Rdata")
```

### determine cis- and trans- eQTL using lodint 
Also tried with lodint() to get QTL interval, no big difference compared to bayesint() 

```{r} 
library(ggplot2) 
load("~/F2/output/eQTL/cis_trans_result_new_flipped.Rdata") 

cis_eQTL %>% dim() # 11384    12
trans_eQTL %>% dim() # 15197    12  

cis_eQTL$class <- rep("cis", nrow(cis_eQTL)) 
trans_eQTL$class <- rep("trans", nrow(trans_eQTL))   

# get only main chromosome stuff   
eQTL <- rbind(cis_eQTL, trans_eQTL) 
eQTL <- eQTL[grep("random", eQTL$CHROM, value = FALSE, invert = T),] # random scaffolds are exluced 
eQTL$class <- factor(eQTL$class, levels = c("cis", "trans"))
eQTL$CHROM <- gsub("(chr)([[:print:]]+)", "\\2", eQTL$CHROM)
eQTL$eQTL_chr <- gsub("(chr)([[:print:]]+)", "\\2", eQTL$eQTL_chr)
eQTL$CHROM <- factor(eQTL$CHROM, levels = c("C09", "C08", "C07", "C06", "C05", "C04", "C03", "C02", "C01", "A10", "A09", "A08", "A07", "A06", "A05", "A04", "A03", "A02", "A01"))
eQTL$eQTL_chr <- factor(eQTL$eQTL_chr, levels = c("A01", "A02", "A03", "A04", "A05", "A06", "A07", "A08", "A09", "A10", "C01", "C02", "C03", "C04", "C05", "C06", "C07", "C08", "C09"))

# plot out the stuff   
p.eQTL <- 
eQTL %>% 
  ggplot() + 
  geom_point(aes(x = pos, y = start, color = class), size = 0.5) +
  facet_grid(CHROM ~ eQTL_chr, switch = "both", scales = "free") + 
  theme_classic() + 
  theme(panel.spacing = unit(0, "lines"), panel.border = element_rect(colour = "black", fill=NA, size=0.1)) + 
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank()) + 
  labs(x = "eQTL genetic position", y = "gene start") + 
  scale_color_manual(values=c("red", "royalblue"))  

p.eQTL      

p.cis_eQTL <-  
eQTL %>% 
  dplyr::filter(class == "cis") %>%
  ggplot() + 
  geom_point(aes(x = pos, y = start), size = 0.5) +
  facet_grid(eQTL_chr ~ CHROM, scales = "free", switch="both") + 
  theme_classic() +
  theme(panel.spacing = unit(0, "lines"), panel.border = element_rect(colour = "black", fill=NA, size=0.1)) +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank()) + 
  labs(x = "eQTL genetic position", y = "gene start")

p.cis_eQTL  

p.trans_eQTL <- 
eQTL %>% 
  dplyr::filter(class == "trans") %>%
  ggplot() + 
  geom_point(aes(x = pos, y = start), size = 0.5) + # x is genetic position of eQTL, y is physical start position of gene 
  facet_grid(eQTL_chr ~ CHROM, scales = "free", switch="both") + 
  theme_classic() +
  theme(panel.spacing = unit(0, "lines"), panel.border = element_rect(colour = "black", fill=NA, size=0.1)) +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank()) + 
  labs(x = "eQTL genetic position", y = "gene start")   

ggsave(p.eQTL, filename = "~/F2/output/eQTL/figure/p.eQTL.flipped.png", height = 10, width = 10) 
ggsave(p.cis_eQTL, filename = "~/F2/output/eQTL/figure/p.cis_eQTL.flipped.png", height = 10, width = 10)
ggsave(p.trans_eQTL, filename = "~/F2/output/eQTL/figure/p.trans_eQTL.flipped.png", height = 10, width = 10) 

### check to see the rate of different vs same subgenome trans-regulators 
eQTL %>% colnames()
eQTL$eQTL_subgenome <- gsub("(A|C)([[:digit:]]+)", "\\1", eQTL$eQTL_chr)
eQTL$gene_subgenome <-  gsub("(A|C)([[:digit:]]+)", "\\1", eQTL$CHROM)

sum(eQTL$eQTL_subgenome == eQTL$gene_subgenome) /nrow(eQTL) # 72% from the same subgenome 

A_genes <- eQTL[eQTL$eQTL_subgenome == "A",] 
sum(A_genes$eQTL_subgenome == A_genes$gene_subgenome) /nrow(A_genes) # 73% 

C_genes <- eQTL[eQTL$eQTL_subgenome == "C",] 
sum(C_genes$eQTL_subgenome == C_genes$gene_subgenome) /nrow(C_genes) # 70%  
```

### find overlaps between eQTL & trait QTL  
```{r}
# trait QTL using scanone result 
load("~/F2/output/QTL_analysis/traitQTL.annotated.flipped.Rdata")
load("~/F2/output/eQTL/cis_trans_result_new_flipped.Rdata") 

cis_eQTL %>% dim() #  11384    12  
trans_eQTL %>% dim() # 15197    12   

traitQTL.annotated %>% colnames() 

cis_eQTL.qtl.combined <- inner_join(cis_eQTL,traitQTL.annotated,by="gene_ID") 
cis_eQTL.qtl.combined %>% head()    
cis_eQTL.qtl.combined %>% dim() # 2180   22  

colnames(cis_eQTL.qtl.combined) 

# how to find trans-eQTL, need to redo, this is incorrect!!! 
# trans_eQTL.qtl.combined <- inner_join(trans_eQTL,traitQTL.annotated,by="gene_ID") 
# trans_eQTL.qtl.combined %>% head()    
# trans_eQTL.qtl.combined %>% dim() # 2110    21  
#   
# colnames(cis_eQTL.qtl.combined)

cis_eQTL.qtl.combined.final <- 
cis_eQTL.qtl.combined %>% 
  mutate(eQTL_start = start.x, eQTL_end = end.x, QTL_start = start.y, QTL_end = end.y) %>% 
  dplyr::select(-c(start.x, end.x, start.y, end.y)) 
  
# trans_eQTL.qtl.combined.final <- 
# trans_eQTL.qtl.combined %>% 
#   mutate(eQTL_start = start.x, eQTL_end = end.x, QTL_start = start.y, QTL_end = end.y) %>% 
#   dplyr::select(-c(start.x, end.x, start.y, end.y)) 

write.csv(cis_eQTL.qtl.combined.final, file = "~/F2/output/eQTL/cis_eQTL.qtl.combined.final.csv")   
# write.csv(trans_eQTL.qtl.combined.final, file = "~/F2/output/eQTL/trans_eQTL.qtl.combined.final.csv") 

### make some plot for several important genes 
# the two FAE 

# the two 
### make some table & plot for several important genes 
# 1) Fatty acid/flowering/growth related genes for cis-eQTL final list 
cis_eQTL.qtl.combined.final[grep("lipid|fatty", cis_eQTL.qtl.combined.final$GO_des),] %>% 
    dplyr::select(gene_ID, trait.y, AGI, At_symbol, GO_des) %>% 
  View()

# 2) transcription factor coding genes for cis-eQTL final list
View(cis_eQTL.qtl.combined.final[grep("DNA|nucleotide|transcription", cis_eQTL.qtl.combined.final$GO_des),])  

# 3) Fatty acid/flowering/growth related genes for trans-eQTL final list
# trans_eQTL.qtl.combined.final[grep("lipid|fatty", trans_eQTL.qtl.combined.final$GO_des),] %>% 
#     dplyr::select(gene_ID, trait.y, AGI, At_symbol, GO_des) %>% 
#   View() 
# 
# trans_eQTL.qtl.combined.final[grep("lipid|fatty", trans_eQTL.qtl.combined.final$GO_des),] %>% 
#   View()  

# 4) figures for the two cis-eQTL gene 
# BnaA08g11060D & BnaA08g11140D two cis-eQTL gene for fatty acid, need to deal with the color problem... more colors than a single palette can handel... 
# save(cis_eQTL.qtl.combined.final, trans_eQTL.qtl.combined.final, file = "~/F2/output/eQTL/eQTL.qtl.combined.final.Rdata") 

### check whether FLC is cis-regulator for some the traits 
# load("~/F2/output/eQTL/eQTL.qtl.combined.final.Rdata")

cis_eQTL.qtl.combined.final %>%  
  filter(AGI == "AT5G10140") %>% 
  View() # FLC is cis-regulator    

#### other important flower genes under C06? 
### important flower related genes 
flowering_time_gene <- read.csv("~/F2/for_paper/flowering_time/flowering_time_genes.csv")
flowering_time_gene$Gene.number <- gsub("\\ ", "", flowering_time_gene$Gene.number)
flowering_time_gene$Gene.number <- gsub("\\\xca", "", flowering_time_gene$Gene.number) 

cis_eQTL.qtl.combined.final[cis_eQTL.qtl.combined.final$AGI %in% flowering_time_gene$Gene.number,] %>% 
  dplyr::select(gene_ID, trait.y, AGI, At_symbol, GO_des) %>%
  View()

# trans_eQTL.qtl.combined.final[trans_eQTL.qtl.combined.final$AGI %in% flowering_time_gene$Gene.number,] %>% 
#   dplyr::select(gene_ID, trait.y, AGI, At_symbol, GO_des) %>%
#   View()  
```
 
######## 
plot out cis-eQTL result for oil traits and growth traits 
```{r}
load("~/F2/output/QTL_analysis/cim.perm.43traits.flipped.Rdata")
load("~/F2/output/QTL_analysis/cim.qtl.43traits.flipped.Rdata")
load("~/F2/output/QTL_analysis/scanone.perm.imp.43traits.flipped")
load("~/F2/output/QTL_analysis/scanone.imp.43traits.flipped")

load("~/F2/output/eQTL/scanone-eqtl_F2_flipped.RData")
scanone_eQTL.F2 %>% dim() # 4887 56182 

cim.qtl[["BnaA08g11140D"]] <- scanone_eQTL.F2[,c("chr", "pos", "BnaA08g11140D")] 
colnames(cim.qtl[["BnaA08g11140D"]])[3] <- "lod"

cim.qtl[["BnaA08g11060D"]] <- scanone_eQTL.F2[,c("chr", "pos", "BnaA08g11060D")] 
colnames(cim.qtl[["BnaA08g11060D"]])[3] <- "lod" 

oil_eQTL <- 
qtl_plot(input = rbind(data.frame(cim.qtl[["Erucic_acid"]], method = "Erucic_acid"), 
                       data.frame(cim.qtl[["Oleic_acid"]], method = "Oleic_acid"), 
                       data.frame(cim.qtl[["BnaA08g11140D"]], method = "BnaA08g11140D"),
                       data.frame(cim.qtl[["BnaA08g11060D"]], method = "BnaA08g11060D")),     
         chrs = c("A08"), 
         # lod = cim.perm[[1]], 
         title = "cis-regulators for oil composition traits", 
         rug = TRUE)   
ggsave(oil_eQTL$plot, filename = "~/F2/output/eQTL/figure/oil_eQTL.png", width = 5, height = 5) 
# Lipid biosynthesis: Arabidopsis squalene synthase homolog  
# FAE coding gene 

load("~/F2/output/growth_model/scanone_growth_model_trait_flipped.Rdata")
load("~/F2/output/growth_model/cim_growth_model_trait_flipped.Rdata") 

cim_growth_model_trait.F2[["BnaA10g22080D"]] <- scanone_eQTL.F2[,c("chr", "pos", "BnaA10g22080D")] 
colnames(cim_growth_model_trait.F2[["BnaA10g22080D"]])[3] <- "lod"

growth_eQTL <- 
qtl_plot(input = rbind(data.frame(cim.qtl[["days_to_bolt"]], method = "days_to_bolt"), 
                       data.frame(cim.qtl[["days_to_flower"]], method = "days_to_flower"), 
                       data.frame(cim_growth_model_trait.F2[["height_Hmax"]], method = "height_Hmax"), 
                       data.frame(cim_growth_model_trait.F2[["leaf_number_I"]], method = "leaf_number_I"), 
                       data.frame(cim_growth_model_trait.F2[["BnaA10g22080D"]], method = "BnaA10g22080D")),     
         chrs = c("A10"), 
         # lod = cim.perm[[1]], 
         title = "cis-regulators for flowering and growth traits", 
         rug = TRUE)   
ggsave(growth_eQTL$plot, filename = "~/F2/output/eQTL/figure/growth_eQTL.png", width = 6, height = 5)  
```

### why FLC is disappearing for time_to_flowering trait 
```{r}
traitQTL.annotated %>% 
  filter(trait == "days_to_flower") %>% 
  dplyr::select(start, end, chrom) %>% 
  unique()

traitQTL.annotated %>% 
  filter(trait == "days_to_bolt") %>% 
  dplyr::select(start, end, chrom) %>% 
  unique()

gff.mRNA[gff.mRNA$gene_ID == "BnaA10g22080D",]

cis_eQTL.qtl.combined.final[cis_eQTL.qtl.combined.final$gene_ID == "BnaA10g22080D",] %>% View() 
traitQTL.annotated %>% View() 
```




